# 离线使用说明

## ✅ 已实现离线支持

本工具现已支持完全离线使用，无需网络连接！

## 🎯 解决的问题

### 之前的问题
- ❌ 依赖CDN加载ECharts库
- ❌ 没有网络时显示"echarts is not defined"错误
- ❌ Windows防火墙可能阻止CDN访问

### 现在的方案
- ✅ ECharts库已本地化（1.0MB）
- ✅ 完全离线可用
- ✅ 不依赖任何外部网络资源

## 📁 新增的文件

```
excel-draw-tool/
├── static/
│   └── js/
│       └── echarts.min.js    # 1.0MB ECharts库
├── templates/
│   └── index.html            # 已更新为使用本地ECharts
└── build.spec                # 已配置打包static目录
```

## 🚀 使用方式

### 本地开发

```bash
# 启动应用
./start.sh

# 或手动启动
source venv/bin/activate
python app.py
```

访问 http://localhost:5000 - 完全离线可用！

### 打包后的可执行文件

生成的可执行文件包含：
- ✅ ECharts库（本地）
- ✅ HTML模板
- ✅ Python运行时
- ✅ 所有依赖库

**完全独立运行，无需网络！**

## 🧪 验证离线功能

### 测试步骤

1. **断开网络**
   - Windows: 关闭WiFi/拔掉网线
   - macOS: 关闭WiFi
   - Linux: 断开网络连接

2. **启动应用**
   ```bash
   python app.py
   ```

3. **测试功能**
   - 访问 http://localhost:5000
   - 上传Excel文件
   - 选择模块
   - 生成图表
   - **确认图表正常显示**

4. **验证成功标志**
   - ✅ 页面正常加载
   - ✅ 不显示"echarts is not defined"错误
   - ✅ 图表正常渲染
   - ✅ 所有交互功能正常

## 📦 打包配置

`build.spec` 已更新，确保打包时包含静态文件：

```python
datas=[
    ('templates', 'templates'),  # HTML模板
    ('static', 'static'),        # 静态资源（包括ECharts）
    ('sample_defect_data.xlsx', '.'),
    ('README.md', '.'),
    ('QUICKSTART.md', '.'),
],
```

## 🔧 技术细节

### 本地化ECharts

1. **下载ECharts**
   ```bash
   mkdir -p static/js
   curl -o static/js/echarts.min.js \
     https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js
   ```

2. **HTML引用**
   ```html
   <!-- 之前：使用CDN -->
   <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
   
   <!-- 现在：使用本地文件 -->
   <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
   ```

3. **Flask配置**
   - Flask自动提供 `/static/` 路由
   - 无需额外配置

### ECharts版本

- **版本**: 5.4.3
- **大小**: 1.0MB
- **格式**: 压缩版（.min.js）
- **功能**: 完整版，包含所有图表类型

## 🌐 网络环境兼容

### 离线环境
- ✅ 完全支持
- ✅ 所有功能可用

### 在线环境
- ✅ 同样支持
- ✅ 使用本地库，更快加载
- ✅ 不受CDN限制

### 特殊网络环境
- ✅ 内网环境
- ✅ 防火墙限制
- ✅ 代理环境
- ✅ 无公网访问

## 📊 性能优势

### 之前（CDN）
- ⏱️ 首次加载：取决于网络速度
- 🌐 依赖外部CDN
- ❌ 离线不可用

### 现在（本地）
- ⚡ 首次加载：本地读取，极快
- 💾 独立运行
- ✅ 离线可用

## 🔍 故障排查

### 问题1: 图表仍然不显示

**检查清单**:
- [ ] 确认 `static/js/echarts.min.js` 文件存在
- [ ] 文件大小约1.0MB
- [ ] 浏览器控制台无错误
- [ ] Flask应用正常启动

**解决方法**:
```bash
# 重新下载ECharts
cd static/js
curl -o echarts.min.js https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js

# 验证文件
ls -lh echarts.min.js
```

### 问题2: 打包后找不到静态文件

**原因**: build.spec配置不正确

**解决方法**:
检查 `build.spec` 中的 `datas` 配置是否包含：
```python
('static', 'static'),
```

### 问题3: 浏览器缓存问题

**解决方法**:
```
Ctrl + Shift + R (Windows/Linux)
Cmd + Shift + R (macOS)
```
强制刷新页面，清除缓存。

## 🎉 升级说明

从旧版本升级：

1. **拉取最新代码**
   ```bash
   git pull origin main
   ```

2. **验证文件**
   ```bash
   ls -lh static/js/echarts.min.js
   ```
   应该显示约1.0MB的文件

3. **重启应用**
   ```bash
   ./start.sh
   ```

4. **测试离线功能**
   - 断网测试
   - 验证图表显示

## 📝 更新日志

**2026-01-18**
- ✅ 下载ECharts 5.4.3到本地
- ✅ 更新HTML使用本地库
- ✅ 配置PyInstaller打包静态文件
- ✅ 添加离线使用文档
- ✅ 测试验证离线功能

## 💡 最佳实践

### 开发环境
1. 保留 `static/js/echarts.min.js` 在版本控制中
2. 不要修改ECharts库文件
3. 需要更新时重新下载

### 生产环境
1. 使用打包后的可执行文件
2. 无需安装任何依赖
3. 完全独立运行

### 部署到服务器
1. 确保 `static` 目录被正确上传
2. 验证文件权限
3. 测试应用启动

## 🔗 相关链接

- [ECharts官网](https://echarts.apache.org/)
- [ECharts GitHub](https://github.com/apache/echarts)
- [Flask静态文件文档](https://flask.palletsprojects.com/en/2.3.x/tutorial/static/)

---

**现在可以完全离线使用了！** 🎉✨

无需担心网络问题，随时随地使用本工具进行缺陷数据分析！

